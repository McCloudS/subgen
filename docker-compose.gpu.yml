# SubGen Docker Compose Configuration - GPU/CUDA Version
# Requires NVIDIA GPU and nvidia-container-toolkit installed
# Copy .env.example to .env and configure before running

services:
  subgen:
    container_name: subgen-gpu

    # Option 1: Build from local Dockerfile (GPU/CUDA)
    build:
      context: .
      dockerfile: Dockerfile

    # Option 2: Use pre-built image (uncomment to use instead of building)
    # image: mccloud/subgen:latest

    restart: unless-stopped

    # NVIDIA GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # Use 'all' to use all GPUs
              capabilities: [gpu]

    # Environment variables - configure in .env file
    environment:
      # Core Configuration - GPU optimized
      - WHISPER_MODEL=${WHISPER_MODEL:-medium}
      - TRANSCRIBE_DEVICE=${TRANSCRIBE_DEVICE:-gpu}
      - WHISPER_THREADS=${WHISPER_THREADS:-4}
      - CONCURRENT_TRANSCRIPTIONS=${CONCURRENT_TRANSCRIPTIONS:-2}
      - MODEL_PATH=/subgen/models
      - COMPUTE_TYPE=${COMPUTE_TYPE:-auto}

      # Processing Behavior
      - PROCESS_ADDED_MEDIA=${PROCESS_ADDED_MEDIA:-True}
      - PROCESS_MEDIA_ON_PLAY=${PROCESS_MEDIA_ON_PLAY:-False}
      - TRANSCRIBE_OR_TRANSLATE=${TRANSCRIBE_OR_TRANSLATE:-transcribe}

      # Subtitle Configuration
      - SUBTITLE_LANGUAGE_NAME=${SUBTITLE_LANGUAGE_NAME:-aa}
      - SKIP_IF_INTERNAL_SUBTITLES_LANGUAGE=${SKIP_IF_INTERNAL_SUBTITLES_LANGUAGE:-eng}
      - SKIP_IF_EXTERNAL_SUBTITLES_EXIST=${SKIP_IF_EXTERNAL_SUBTITLES_EXIST:-False}
      - WORD_LEVEL_HIGHLIGHT=${WORD_LEVEL_HIGHLIGHT:-False}
      - LRC_FOR_AUDIO_FILES=${LRC_FOR_AUDIO_FILES:-True}
      - APPEND=${APPEND:-False}

      # Media Server Configuration
      - PLEX_SERVER=${PLEX_SERVER:-http://plex:32400}
      - PLEX_TOKEN=${PLEX_TOKEN}
      - JELLYFIN_SERVER=${JELLYFIN_SERVER:-http://jellyfin:8096}
      - JELLYFIN_TOKEN=${JELLYFIN_TOKEN}
      - WEBHOOK_PORT=${WEBHOOK_PORT:-9000}

      # Path Mapping (if media server and subgen have different paths)
      - USE_PATH_MAPPING=${USE_PATH_MAPPING:-False}
      - PATH_MAPPING_FROM=${PATH_MAPPING_FROM:-/tv}
      - PATH_MAPPING_TO=${PATH_MAPPING_TO:-/tv}

      # Advanced Options - GPU specific
      - DEBUG=${DEBUG:-True}
      - UPDATE=${UPDATE:-False}
      - CLEAR_VRAM_ON_COMPLETE=${CLEAR_VRAM_ON_COMPLETE:-True}
      - CUSTOM_REGROUP=${CUSTOM_REGROUP:-cm_sl=84_sl=42++++++1}
      - USE_MODEL_PROMPT=${USE_MODEL_PROMPT:-False}
      - CUSTOM_MODEL_PROMPT=${CUSTOM_MODEL_PROMPT}

      # Batch Processing
      - TRANSCRIBE_FOLDERS=${TRANSCRIBE_FOLDERS}
      - MONITOR=${MONITOR:-False}

    volumes:
      # Media folders - MUST match Plex/Jellyfin/Emby paths unless using PATH_MAPPING
      - ${TV_PATH:-./media/tv}:/tv
      - ${MOVIES_PATH:-./media/movies}:/movies

      # Model storage (persistent to avoid re-downloading)
      - ${MODELS_PATH:-./models}:/subgen/models

      # Optional: Mount custom config
      # - ${CONFIG_PATH:-./config}:/config

    ports:
      - "${WEBHOOK_PORT:-9000}:9000"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
